<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SIMEDIS Scenario Generator</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <link rel="icon" href="/icons/icon.png" type="image/png" />
  <style>
    /* Reset & base */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f8;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
      min-height: 100vh;
    }

    header {
      width: 100%;
      max-width: 900px;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-weight: 700;
      font-size: 2.5rem;
      color: #0078d4;
      letter-spacing: 0.03em;
    }

    main.container {
      width: 100%;
      max-width: 900px;
      background: #fff;
      padding: 2rem 2.5rem;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      gap: 1.8rem;
    }

    /* Controls panel */
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 1.5rem;
      align-items: center;
      justify-content: center;
    }

    #controls select,
    #controls button {
      padding: 0.5rem 0.9rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1.8px solid #ddd;
      background-color: #fff;
      transition: border-color 0.25s ease, background-color 0.25s ease;
      cursor: pointer;
      min-width: 160px;
    }

    #controls select:focus,
    #controls button:focus {
      outline: none;
      border-color: #0078d4;
      box-shadow: 0 0 6px rgba(0, 120, 212, 0.5);
    }

    #controls button {
      background-color: #0078d4;
      color: white;
      border-color: #0078d4;
      min-width: 140px;
      font-weight: 600;
      user-select: none;
    }

    #controls button:hover:not(:disabled) {
      background-color: #005ea2;
      border-color: #005ea2;
    }

    #controls button:disabled {
      background-color: #cfd8dc;
      border-color: #cfd8dc;
      cursor: default;
      color: #757575;
    }

    /* Checkbox label inline */
    #controls label {
      display: flex;
      align-items: center;
      font-weight: 500;
      font-size: 0.95rem;
      gap: 0.3rem;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    #controls label input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    /* Link styling */
    #controls a {
      color: #0078d4;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.95rem;
      align-self: center;
      white-space: nowrap;
    }
    #controls a:hover,
    #controls a:focus {
      text-decoration: underline;
    }

    /* Status and outputs */
    #status {
      font-weight: 600;
      font-size: 1.1rem;
      color: #0078d4;
      text-align: center;
      min-height: 1.5em;
      user-select: none;
    }

    #output,
    #generationOutput {
      background-color: #f9f9f9;
      border: 1.5px solid #ddd;
      padding: 1rem 1.2rem;
      border-radius: 10px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.9rem;
      max-height: 320px;
      overflow-y: auto;
      white-space: pre-wrap;
      color: #222;
    }

    #generationOutput {
      max-height: 220px;
      margin-top: 0.5rem;
    }

    /* Map styling */
    #map {
      width: 100%;
      height: 520px;
      border-radius: 12px;
      border: 2px solid #ddd;
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
      margin-top: 1rem;
      user-select: none;
    }

    /* Route info & loading */
    #routeInfo {
      font-size: 1rem;
      font-weight: 600;
      color: #444;
      margin-top: 0.7rem;
      text-align: center;
      user-select: none;
    }

    #loading {
      font-style: italic;
      color: #0078d4;
      text-align: center;
      margin-top: 0.4rem;
      user-select: none;
    }

    /* Responsive adjustments */
    @media (max-width: 720px) {
      main.container {
        padding: 1.5rem 1.5rem;
      }
      #controls {
        flex-direction: column;
        gap: 1rem;
      }
      #controls select,
      #controls button {
        min-width: 100%;
      }
      #map {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <header style="text-align: center; padding: 10px;">
    <h1>SIMEDIS Scenario Generator</h1>
  </header>

    <main class="container" role="main" aria-label="Scenario generator controls and map">

    <section id="controls" aria-label="Scenario controls">
      <select id="type" aria-label="Select location type">
        <option value="threat">Threat</option>
        <option value="hospital">Hospital</option>
        <option value="ccp">Casualty Collection Point</option>
      </select>

      <select id="threatType" aria-label="Select threat type">
        <option value="artillery strike">Artillery Strike</option>
        <option value="drone strike">Drone Strike</option>
        <option value="GB release">GB Release</option>
      </select>

      <select id="hospitalType" style="display:none" aria-label="Select hospital role type">
        <option value="role 1">Role 1</option>
        <option value="role 2">Role 2</option>
        <option value="role 3">Role 3</option>
      </select>

      <select id="travelProfile" aria-label="Select travel profile">
        <option value="car">Car (default)</option>
        <option value="foot">Walking</option>
        <option value="bike">Bike</option>
        <option value="truck">Truck</option>
      </select>

      <button type="button" onclick="submitData()" aria-label="Save current scenario as JSON">Save JSON</button>
      <button type="button" onclick="createScenario()" aria-label="Run custom scenario">Run Custom Scenario</button>
      <button type="button" onclick="generatePatients()" aria-label="Generate patients">Generate Patients</button>
      <button type="button" onclick="clearRoute()" aria-label="Clear all markers and routes">Clear Route</button>
      <button type="button" id="plotVictimsBtn" aria-label="Plot victims on map">Plot Victims</button>
      <button type="button" id="loadHospitalsBtn" aria-label="Load hospitals on map">Load Hospitals</button>
      <button onclick="window.open('/edit_parameters', '_blank')">
        Edit Scenario Parameters
      </button>
            

      <label for="includeRoute">
        <input type="checkbox" id="includeRoute" checked />
        Include Route in JSON
      </label>

      <a href="/db_browser" aria-label="Browse SQLite Databases">🧠 Browse SQLite Databases</a>
    </section>
    <section id="threatConfigModal" style="display:none;" aria-label="Configure Threat">
      <h3>Configure Threat</h3>
      <label for="threatId">Threat ID:</label>
      <input type="text" id="threatId" name="threatId" value="threat1" aria-label="Threat ID" />
      <label for="threatHits">Number of Hits:</label>
      <input type="number" id="threatHits" name="threatHits" min="1" value="3" aria-label="Number of Hits" />

      <label for="victimsPerHit">Victims per Hit:</label>
      <input type="number" id="victimsPerHit" name="victimsPerHit" min="1" value="13" aria-label="Victims per Hit" />

      <label for="threatRadius">Radius of Effect (m):</label>
      <input type="number" id="threatRadius" name="threatRadius" min="1" value="40" aria-label="Threat Radius in meters" />

      <label for="threatDuration">Scheduled time (minutes):</label>
      <input type="number" id="threatDuration" name="scheduledTime" min="0.0" value="0.0" aria-label="Scheduled time in minutes" />

      
      <button onclick="saveThreatConfig()" aria-label="Apply threat configuration">Apply</button>
      <button onclick="closeThreatConfig()">Cancel</button>
    </section>

    <section id="status" aria-live="polite" role="status" style="display:none;"></section>

    <section id="output" style="display:none" aria-label="Scenario output"></section>

    <section id="generationOutput" aria-label="Patient generation output"></section>

    <section id="routeInfo" aria-live="polite" aria-atomic="true">Distance: N/A, ETA: N/A</section>

    <section id="loading" style="display:none" aria-live="assertive" aria-atomic="true">Loading victims...</section>
  

    <div id="map" role="application" aria-label="Interactive map"></div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script>
    let map, routingControl = null, polyline = null;
    const markersData = [], routePoints = [];
    let currentRouteGeoJSON = null;

    const icons = {
      "artillery strike": L.icon({ iconUrl: 'icons/shell.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      "drone strike": L.icon({ iconUrl: 'icons/drone.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      "GB release": L.icon({ iconUrl: 'icons/c.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      "role 1": L.icon({ iconUrl: 'icons/role1.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      "role 2": L.icon({ iconUrl: 'icons/role2.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      "role 3": L.icon({ iconUrl: 'icons/role3.png', iconSize: [32, 32], iconAnchor: [16, 32] }),
      "ccp": L.icon({ iconUrl: 'icons/ccp.png', iconSize: [32, 32], iconAnchor: [16, 32] })
    };

    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      setupControls();
      setupFileLoader();
    });

    function initMap() {
      map = L.map('map').setView([50.85, 4.35], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      map.on('click', addMarker);
    }

    function setupControls() {
      const typeSelect = document.getElementById('type');
      const threatType = document.getElementById('threatType');
      const hospitalType = document.getElementById('hospitalType');

      typeSelect.addEventListener('change', () => {
        threatType.style.display = (typeSelect.value === 'threat') ? 'inline' : 'none';
        hospitalType.style.display = (typeSelect.value === 'hospital') ? 'inline' : 'none';
        if (typeSelect.value === 'ccp') {
        threatType.style.display = 'none';
        hospitalType.style.display = 'none';
        }
      });

      document.getElementById('loadHospitalsBtn').addEventListener('click', loadHospitals);
      document.getElementById('plotVictimsBtn').addEventListener('click', plotVictims);
      document.getElementById('travelProfile').addEventListener('change', createRoute);
            
    }
    function setupFileLoader() {
      document.getElementById("htmlFileInput").addEventListener("change", function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          const blob = new Blob([e.target.result], { type: "text/html" });
          const url = URL.createObjectURL(blob);

          let iframe = document.getElementById("simedis-iframe");
          if (!iframe) {
            iframe = document.createElement("iframe");
            iframe.id = "simedis-iframe";
            iframe.style.width = "100%";
            iframe.style.height = "100%";
            iframe.style.border = "none";
            document.getElementById("simedis-output").innerHTML = "";
            document.getElementById("simedis-output").appendChild(iframe);
          }
          iframe.src = url;
        };
        reader.readAsText(file);
      });
    }
    let threatCounter = 1;
    function addMarker(e) {
      const type = document.getElementById('type').value;
      let subtype = "";
      let icon = null;

      if (type === 'threat') {
        subtype = document.getElementById('threatType').value;
        icon = icons[subtype];
        const threatId = `threat-${threatCounter++}`;
      } else if (type === 'hospital') {
        subtype = document.getElementById('hospitalType').value;
        icon = icons[subtype];
      }  else if (type === 'ccp') {
        subtype = 'ccp';
        icon = icons['ccp'];
      }

      L.marker(e.latlng, { icon }).addTo(map)
        .bindPopup(`${type} (${subtype}) at ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`).openPopup();

      markersData.push({
      id: threatId,
      category: type,
      subtype,
      lat: e.latlng.lat,
      lng: e.latlng.lng
      });
      routePoints.push(L.latLng(e.latlng.lat, e.latlng.lng));
      createRoute();
      openThreatConfig(threatId);
    }
    function triageColor(triage) {
      switch(triage) {
        case "T1": return "red";
        case "T2": return "orange";
        case "T3": return "green";
        case "Dead": return "black";
        default: return "blue";
      }
    }
    const threatConfig = {
      threatId: document.getElementById('threatId').value,
      hits: parseInt(document.getElementById('threatHits').value, 10),
      victimsPerHit: parseInt(document.getElementById('victimsPerHit').value, 10),
      radius: parseFloat(document.getElementById('threatRadius').value),
      scheduledTime: parseFloat(document.getElementById('threatDuration').value)
    };

    function openThreatConfig(threatId, existingConfig = null) {
      const modal = document.getElementById('threatConfigModal');
      if (!modal) return;

      // Show modal
      modal.style.display = 'block';

      // Set threat ID (read-only input)
      document.getElementById('threatId').value = existingConfig?.threatID !== undefined ? existingConfig.threatID : "threat1";

      // Use existing config if present, otherwise use defaults
      document.getElementById('threatHits').value =
        existingConfig?.hits !== undefined ? existingConfig.hits : 3;

      document.getElementById('victimsPerHit').value =
        existingConfig?.victimsPerHit !== undefined ? existingConfig.victimsPerHit : 13;

      document.getElementById('threatRadius').value =
        existingConfig?.radius !== undefined ? existingConfig.radius : 40;

      document.getElementById('threatDuration').value =
        existingConfig?.scheduledTime !== undefined ? existingConfig.scheduledTime : 0.0;
    }


    function closeThreatConfig() {
      const modal = document.getElementById('threatConfigModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    function saveThreatConfig() {
      const threatConfig = {
        id: document.getElementById('threatId').value,
        hits: parseInt(document.getElementById('threatHits').value),
        victimsPerHit: parseInt(document.getElementById('victimsPerHit').value),
        radius: parseFloat(document.getElementById('threatRadius').value),
        scheduledTime: parseFloat(document.getElementById('threatDuration').value)
      };

      fetch('/api/threatconfig', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(threatConfig)
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to save');
        return response.json();
      })
      .then(data => {
        alert(`Saved Threat Configuration:\nID: ${threatConfig.id}\nHits: ${threatConfig.hits}\nVictims/Hit: ${threatConfig.victimsPerHit}\nRadius: ${threatConfig.radius}m\nScheduled Time: ${threatConfig.scheduledTime}min`);
        closeThreatConfig();
      })
      .catch(error => {
        console.error('Error saving threat config:', error);
        alert('Failed to save threat config.');
      });
    }
    function createRoute() {
      if (routingControl) { map.removeControl(routingControl); routingControl = null; }
      if (polyline) { map.removeLayer(polyline); polyline = null; }

      if (routePoints.length < 2) {
        currentRouteGeoJSON = null;
        document.getElementById('routeInfo').textContent = "Distance: N/A, ETA: N/A";
        return;
      }

      routingControl = L.Routing.control({
        waypoints: routePoints,
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: document.getElementById('travelProfile').value }),
        addWaypoints: false,
        show: false,
        createMarker: () => null
      }).addTo(map);

      routingControl.on('routesfound', function(e) {
        const route = e.routes[0];
        document.getElementById('routeInfo').textContent =
          `Distance: ${(route.summary.totalDistance/1000).toFixed(2)} km, ETA: ${(route.summary.totalTime/60).toFixed(1)} min`;
        currentRouteGeoJSON = { type: "LineString", coordinates: route.coordinates.map(c => [c.lng, c.lat]) };
        polyline = L.polyline(route.coordinates, { color: 'blue' }).addTo(map);
      });
    }
  
    async function createScenario() {
      const scenarioName = prompt("Enter scenario name (e.g. demo):", "demo");
      if (!scenarioName) return;

      const statusEl = document.getElementById('status');
      const outputEl = document.getElementById('output');

      statusEl.innerText = `⏳ Running scenario "${scenarioName}"...`;
      statusEl.style.display = 'block';
      outputEl.style.display = 'none';
      outputEl.innerHTML = '';

      try {
        const res = await fetch('/run_scenario', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scenario: scenarioName })
        });

        if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);

        const result = await res.json();

        outputEl.innerHTML = `
          <h3>✅ Scenario "${scenarioName}" Complete</h3>
          <pre><strong>STDOUT:</strong>\n${result.stdout || '(no output)'}\n\n<strong>STDERR:</strong>\n${result.stderr || '(no errors)'}</pre>
        `;
        outputEl.style.display = 'block';
      } catch (err) {
        console.error('Scenario run failed:', err);
        outputEl.innerHTML = `<h3 style="color: red;">❌ Failed to run scenario</h3><pre>${err}</pre>`;
        outputEl.style.display = 'block';
      } finally {
        statusEl.style.display = 'none';
      }
    }
    function loadHospitals() {
      const query = `[out:json][timeout:25];area["ISO3166-1"="BE"][admin_level=2]->.searchArea;` +
                    `(node["amenity"="hospital"]["emergency"="yes"](area.searchArea);` +
                    `way["amenity"="hospital"]["emergency"="yes"](area.searchArea);` +
                    `relation["amenity"="hospital"]["emergency"="yes"](area.searchArea););out center;`;
      fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query))
        .then(res => res.json())
        .then(data => {
          data.elements.forEach(el => {
            const lat = el.lat || el.center?.lat;
            const lon = el.lon || el.center?.lon;
            if (lat && lon) {
              L.marker([lat, lon], { icon: icons['role 3'] })
                .addTo(map)
                .bindPopup(el.tags?.name || 'Hospital');
            }
          });
        })
        .catch(err => alert("Failed to load hospitals: " + err));
    }
    async function generatePatients() {
      try {
        const response = await fetch('/generate_patients', {
          method: 'POST'
        });
        const data = await response.json();
        document.getElementById("generationOutput").textContent =
          "STDOUT:\n" + data.stdout + "\n\nSTDERR:\n" + data.stderr;
      } catch (err) {
        console.error(err);
        document.getElementById("generationOutput").textContent = "Error: " + err;
      }
    }
  

    async function plotVictims() {
      document.getElementById('loading').style.display = 'block';

      // Clear previous victim dots if any
      if (window.victimLayerGroup) {
        window.victimLayerGroup.clearLayers();
      } else {
        window.victimLayerGroup = L.layerGroup().addTo(map);
      }

      try {
        const res = await fetch('http://localhost:8000/get_victims');
        const data = await res.json();
        let count = 0;

        function triageColor(triage) {
          switch (triage) {
            case "1": return "red";
            case "2": return "orange";
            case "3": return "green";
            case "4": return "black";
            default: return "blue";
          }
        }

        data.victims.forEach((victim) => {
          if (!victim.lat || !victim.lng) {
            console.log("Skipped invalid victim data:", victim);
            return;  // skip this victim
          }

          if (typeof victim.lat === "number" && typeof victim.lng === "number") {
            const dot = L.circleMarker([victim.lat, victim.lng], {
              radius: 5,
          fillColor: triageColor(victim.triage),
          color: triageColor(victim.triage),
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8,
        }).bindPopup(`
          <b>ID:</b> ${victim.id}<br>
          <b>Triage:</b> ${victim.triage}<br>
          <b>ISS:</b> ${victim.ISS}<br>
          <b>Lat:</b> ${victim.lat.toFixed(5)}<br>
          <b>Lng:</b> ${victim.lng.toFixed(5)}
        `);

            window.victimLayerGroup.addLayer(dot);
            count++;
          } else {
            console.warn("Skipped invalid victim data (not numbers):", victim);
          }
        });

        alert(`${count} victims plotted.`);
      } catch (err) {
        alert("Error loading victims: " + err);
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }
    function submitData() {

      const statusEl = document.getElementById('status');
      statusEl.style.display = 'block';
      const payload = {
        travelProfile: document.getElementById('travelProfile').value,
        locations: markersData,   // <-- this is the important part
        route: document.getElementById('includeRoute').checked ? currentRouteGeoJSON : null
      };

      fetch('http://localhost:8000/save_coordinates', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),  // make sure you stringify this object
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not OK');
        }
        return response.json();
      })
      .then(data => {
        console.log("Response from save_coordinates:", data);
        alert(`Saved scenario: ${data.file}`);
      })
      .catch(error => {
        console.error('Error:', error);
        alert("Save failed: " + error.message);
      });
    }
   

    function clearRoute() {
      routePoints.length = 0;
      markersData.length = 0;
      if (routingControl) map.removeControl(routingControl);
      if (polyline) map.removeLayer(polyline);
      currentRouteGeoJSON = null;
      document.getElementById('routeInfo').textContent = "Distance: N/A, ETA: N/A";
      map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });
    }

    // function runJuliaScript() {
    //   const consoleOut = document.getElementById('simedisConsoleOutput');
    //   const htmlContent = document.getElementById('simedisHtmlContent');
    //   consoleOut.innerHTML = '<em>Running Julia script...</em>';
    //   htmlContent.innerHTML = '';
    //   fetch('http://localhost:8000/run_julia', { method: 'POST' })
    //     .then(res => res.json())
    //     .then(data => {
    //       consoleOut.innerHTML = `${data.stdout ? '<pre>' + data.stdout + '</pre>' : ''}` +
    //                              `${data.stderr ? '<pre style="color:red;">' + data.stderr + '</pre>' : ''}`;
    //       htmlContent.innerHTML = data.html || '<em>No HTML output.</em>';
    //     })
    //     .catch(err => consoleOut.innerHTML = `<span style='color:red;'>Error: ${err}</span>`);
    // }
  </script>
</body>
</html>
